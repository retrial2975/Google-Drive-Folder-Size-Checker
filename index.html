<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>เครื่องมือตรวจสอบขนาดโฟลเดอร์ Google Drive</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://apis.google.com/js/api.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Sarabun:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Sarabun', 'Inter', sans-serif;
        }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #09f;
            animation: spin 1s ease infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .folder-toggle {
            transition: transform 0.2s ease-in-out;
        }
        .folder-toggle.expanded {
            transform: rotate(90deg);
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 flex items-center justify-center min-h-screen py-8">

    <div class="container mx-auto p-4 md:p-8 max-w-4xl">
        <div class="bg-white rounded-lg shadow-xl p-6 md:p-8">
            <div class="text-center mb-6">
                <h1 class="text-2xl md:text-3xl font-bold text-gray-700">เครื่องมือตรวจสอบขนาดโฟลเดอร์ Google Drive</h1>
                <p class="text-gray-500 mt-2">คำนวณขนาดโฟลเดอร์ใน My Drive และที่แชร์กับฉัน (รวมโฟลเดอร์ย่อย)</p>
            </div>

            <div id="auth-section" class="text-center">
                <p class="mb-4 text-yellow-700 bg-yellow-100 p-3 rounded-md">
                    **สำคัญ:** โปรดทำตามขั้นตอนใน `README.md` เพื่อสร้างและใส่ `API Key` กับ `Client ID` ของคุณในโค้ดก่อนใช้งาน
                </p>
                <button id="authorize_button" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg shadow-md transition-transform transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                    กำลังโหลด...
                </button>
            </div>

            <div id="content-section" class="hidden">
                <div class="flex flex-col sm:flex-row justify-between items-center mb-6 border-b pb-4 gap-4">
                    <div id="user-info" class="text-sm text-center sm:text-left"></div>
                    <div class="flex items-center gap-2">
                        <button id="refresh_button" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg text-sm">โหลดใหม่</button>
                        <button id="signout_button" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg text-sm">ออกจากระบบ</button>
                    </div>
                </div>

                <div id="status" class="text-center my-4 p-4 bg-gray-50 rounded-lg hidden">
                    <div class="flex justify-center items-center">
                        <div class="spinner mr-3"></div>
                        <span id="status-text" class="text-gray-600 font-medium">กำลังโหลดข้อมูล...</span>
                    </div>
                </div>
                
                <div id="my-drive-container" class="mt-4">
                    <h2 class="text-xl font-semibold mb-2">โฟลเดอร์ใน My Drive</h2>
                    <div id="folder-list" class="space-y-1"></div>
                </div>
                
                <div id="shared-drive-container" class="mt-8 pt-6 border-t">
                    <h2 class="text-xl font-semibold mb-2">โฟลเดอร์ที่แชร์กับฉัน</h2>
                    <div id="shared-folder-list" class="space-y-1"></div>
                </div>
            </div>
        </div>
        <footer class="text-center text-gray-500 mt-6 text-sm">
            <p>แอปพลิเคชันนี้ทำงานบนเบราว์เซอร์ของคุณเท่านั้นและไม่ได้เก็บข้อมูลใดๆ ของคุณ</p>
        </footer>
    </div>

    <script>
        // =================================================================
        // CONFIGURATION: กรุณาใส่ Key ของคุณที่นี่
        // =================================================================
        const API_KEY = 'IzaSyDlFHbakiUhpOYFDrzPtF3v2AuSeokETts'; 
        const CLIENT_ID = '387831923230-e56mnndsk8hkmvl3k5q33qq253bb9s9g.apps.googleusercontent.com';
        // =================================================================
        
        if (window.location.protocol === 'file:') {
            alert('ข้อผิดพลาด:\n\nคุณไม่สามารถรันไฟล์นี้โดยตรงได้ (ผ่าน file:///)\n\nกรุณารันไฟล์นี้ผ่านเว็บเซิร์ฟเวอร์จำลอง (เช่น ใช้ Extension "Live Server" ใน VS Code) เพื่อให้ URL เป็น http://localhost');
            document.getElementById('authorize_button').innerText = 'ตั้งค่าไม่ถูกต้อง';
        }

        const DISCOVERY_DOCS = ["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"];
        const SCOPES = 'https://www.googleapis.com/auth/drive.readonly';

        const authorizeButton = document.getElementById('authorize_button');
        const signoutButton = document.getElementById('signout_button');
        const refreshButton = document.getElementById('refresh_button');

        let gapiInited = false;
        let gisInited = false;
        let tokenClient;

        document.addEventListener('DOMContentLoaded', () => {
            gapi.load('client', initializeGapiClient);
            const script = document.createElement('script');
            script.src = 'https://accounts.google.com/gsi/client';
            script.async = true;
            script.defer = true;
            script.onload = initializeGis;
            document.body.appendChild(script);
        });

        async function initializeGapiClient() {
            if (API_KEY === 'YOUR_API_KEY' || API_KEY === '') {
                authorizeButton.innerText = 'กรุณาตั้งค่า API Key'; return;
            }
            await gapi.client.init({ apiKey: API_KEY, discoveryDocs: DISCOVERY_DOCS });
            gapiInited = true; maybeEnableButtons();
        }

        function initializeGis() {
            if (CLIENT_ID === 'YOUR_CLIENT_ID' || CLIENT_ID === '') {
                 authorizeButton.innerText = 'กรุณาตั้งค่า Client ID'; return;
            }
            try {
                tokenClient = google.accounts.oauth2.initTokenClient({
                    client_id: CLIENT_ID, scope: SCOPES, callback: '',
                });
                gisInited = true; maybeEnableButtons();
            } catch (err) {
                console.error("Error initializing Google Identity Services:", err);
                authorizeButton.innerText = 'Client ID ไม่ถูกต้อง';
            }
        }

        function maybeEnableButtons() {
            if (gapiInited && gisInited && window.location.protocol !== 'file:') {
                authorizeButton.disabled = false;
                authorizeButton.innerText = 'เชื่อมต่อกับ Google Drive';
                authorizeButton.onclick = handleAuthClick;
                signoutButton.onclick = handleSignoutClick;
                refreshButton.onclick = () => {
                    listRootFolders();
                    listSharedFolders();
                };
            }
        }

        function handleAuthClick() {
            tokenClient.callback = (resp) => { if (resp.error) throw(resp); updateSigninStatus(true); };
            tokenClient.requestAccessToken({prompt: gapi.client.getToken() === null ? 'consent' : ''});
        }

        function handleSignoutClick() {
            const token = gapi.client.getToken();
            if (token) {
                google.accounts.oauth2.revoke(token.access_token, () => {
                    gapi.client.setToken('');
                    updateSigninStatus(false);
                });
            }
        }

        function updateSigninStatus(isSignedIn) {
            if (isSignedIn) {
                document.getElementById('auth-section').classList.add('hidden');
                document.getElementById('content-section').classList.remove('hidden');
                displayUserInfo();
                listRootFolders();
                listSharedFolders();
            } else {
                document.getElementById('folder-list').innerHTML = '';
                document.getElementById('shared-folder-list').innerHTML = '';
                document.getElementById('user-info').innerHTML = '';
                document.getElementById('auth-section').classList.remove('hidden');
                document.getElementById('content-section').classList.add('hidden');
            }
        }

        async function displayUserInfo() {
             try {
                const res = await gapi.client.drive.about.get({ fields: 'user' });
                document.getElementById('user-info').innerHTML = `<p class="font-semibold">${res.result.user.displayName}</p><p class="text-gray-500">${res.result.user.emailAddress}</p>`;
            } catch (err) { console.error("Error fetching user info:", err); }
        }

        async function listRootFolders() {
            await listFolders("'root' in parents", document.getElementById('folder-list'), "ไม่พบโฟลเดอร์ใน My Drive");
        }

        async function listSharedFolders() {
            await listFolders("sharedWithMe = true", document.getElementById('shared-folder-list'), "ไม่พบโฟลเดอร์ที่แชร์กับฉัน");
        }

        async function listFolders(query, container, emptyMessage) {
            container.innerHTML = '<p class="text-gray-500 px-3">กำลังโหลด...</p>';
            document.getElementById('status').classList.remove('hidden');
            document.getElementById('status-text').textContent = 'กำลังโหลดรายการโฟลเดอร์...';

            try {
                const response = await gapi.client.drive.files.list({
                    q: `${query} and mimeType='application/vnd.google-apps.folder' and trashed=false`,
                    pageSize: 200,
                    fields: 'files(id, name)'
                });
                container.innerHTML = '';
                const folders = response.result.files;
                if (folders && folders.length > 0) {
                    folders.forEach(folder => {
                        const folderElement = createFolderElement(folder, 0);
                        container.appendChild(folderElement);
                        calculateAndDisplaySize(folder.id);
                    });
                } else {
                    container.innerHTML = `<p class="text-gray-500 text-center px-3">${emptyMessage}</p>`;
                }
            } catch (err) {
                console.error("Execute error:", err);
                container.innerHTML = '<p class="text-red-500 text-center px-3">เกิดข้อผิดพลาดในการโหลดข้อมูล</p>';
            }
            checkIfDoneLoading();
        }

        function checkIfDoneLoading() {
            const myDriveStatus = document.getElementById('folder-list').innerHTML;
            const sharedStatus = document.getElementById('shared-folder-list').innerHTML;
            if (!myDriveStatus.includes('กำลังโหลด...') && !sharedStatus.includes('กำลังโหลด...')) {
                 document.getElementById('status').classList.add('hidden');
            }
        }
        
        function createFolderElement(folder, level) {
            const fragment = document.createDocumentFragment();
            const mainDiv = document.createElement('div');
            mainDiv.id = `folder-${folder.id}`;
            mainDiv.className = 'p-2 bg-gray-50 rounded-md border flex justify-between items-center cursor-pointer hover:bg-gray-100';
            mainDiv.style.marginLeft = `${level * 20}px`;
            mainDiv.onclick = (e) => { e.stopPropagation(); toggleSubfolders(folder.id); };

            mainDiv.innerHTML = `
                <div class="flex items-center min-w-0 mr-4">
                     <svg id="toggle-${folder.id}" xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-gray-500 mr-2 flex-shrink-0 folder-toggle" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg>
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-yellow-500 mr-2 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z" /></svg>
                    <span class="font-medium truncate" title="${folder.name}">${folder.name}</span>
                </div>
                <div class="size-container text-gray-600 font-semibold text-right">
                    <div class="flex items-center justify-end">
                        <div class="spinner w-4 h-4 mr-2" style="border-width: 2px;"></div>
                        <span>...</span>
                    </div>
                </div>`;
            
            const subfolderContainer = document.createElement('div');
            subfolderContainer.id = `subfolders-${folder.id}`;
            subfolderContainer.className = 'hidden space-y-1 mt-1';
            
            fragment.appendChild(mainDiv);
            fragment.appendChild(subfolderContainer);
            return fragment;
        }

        async function toggleSubfolders(folderId) {
            const subfolderContainer = document.getElementById(`subfolders-${folderId}`);
            const toggleIcon = document.getElementById(`toggle-${folderId}`);
            
            const isExpanded = !subfolderContainer.classList.toggle('hidden');
            toggleIcon.classList.toggle('expanded', isExpanded);

            if (isExpanded && subfolderContainer.innerHTML === '') {
                subfolderContainer.innerHTML = `<p class="text-gray-500" style="margin-left: ${(parseInt(subfolderContainer.previousElementSibling.style.marginLeft) || 0) + 20}px;">กำลังโหลด...</p>`;
                try {
                    const response = await gapi.client.drive.files.list({
                        q: `'${folderId}' in parents and mimeType='application/vnd.google-apps.folder' and trashed=false`,
                        fields: 'files(id, name)'
                    });
                    subfolderContainer.innerHTML = '';
                    const subfolders = response.result.files;
                    if (subfolders && subfolders.length > 0) {
                         const currentLevel = (parseInt(subfolderContainer.previousElementSibling.style.marginLeft) || 0) / 20;
                        subfolders.forEach(subfolder => {
                            const subfolderElement = createFolderElement(subfolder, currentLevel + 1);
                            subfolderContainer.appendChild(subfolderElement);
                            calculateAndDisplaySize(subfolder.id);
                        });
                    } else {
                        subfolderContainer.innerHTML = `<p class="text-gray-400 text-sm" style="margin-left: ${(parseInt(subfolderContainer.previousElementSibling.style.marginLeft) || 0) + 40}px;">- ไม่มีโฟลเดอร์ย่อย -</p>`;
                    }
                } catch (err) {
                    console.error("Error fetching subfolders:", err);
                    subfolderContainer.innerHTML = `<p class="text-red-500">Error</p>`;
                }
            }
        }

        async function calculateAndDisplaySize(folderId) {
            const sizeContainer = document.querySelector(`#folder-${folderId} .size-container`);
            try {
                let totalSize = 0;
                const folderStack = [folderId];
                let processedFolders = new Set();
                while (folderStack.length > 0) {
                    const currentFolderId = folderStack.pop();
                    if (processedFolders.has(currentFolderId)) continue;
                    processedFolders.add(currentFolderId);
                    let pageToken = null;
                    do {
                        const response = await gapi.client.drive.files.list({
                            q: `'${currentFolderId}' in parents and trashed=false`,
                            fields: 'nextPageToken, files(id, name, mimeType, size)',
                            pageSize: 1000,
                            pageToken: pageToken
                        });
                        for (const file of response.result.files) {
                            if (file.mimeType === 'application/vnd.google-apps.folder') {
                                folderStack.push(file.id);
                            } else {
                                totalSize += parseInt(file.size || 0, 10);
                            }
                        }
                        pageToken = response.result.nextPageToken;
                    } while (pageToken);
                }
                sizeContainer.innerHTML = `<span>${formatBytes(totalSize)}</span>`;
            } catch (error) {
                console.error(`Error calculating size for folder ${folderId}:`, error);
                sizeContainer.innerHTML = `<span class="text-red-500">Error</span>`;
            }
        }

        function formatBytes(bytes, decimals = 2) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const dm = decimals < 0 ? 0 : decimals;
            const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
        }
    </script>
</body>
</html>

